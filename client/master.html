<!DOCTYPE html>
<html>
  <head>
    <meta name="screen-orientation" content="portrait" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0"
    />
    <title>Âπ¥‰ºöÊäΩÂ•ñÂ∞èÁ®ãÂ∫è</title>
    <link rel="stylesheet" type="text/css" href="css/reset.css" />
    <style type="text/css">
      html,
      body {
        width: 100%;
        height: 100%;
      }

      .wall {
        width: 100%;
        height: 100%;
        background-image: url(./img/icon-wall.jpg);
        overflow: hidden;
        background-color: #121936;
        background-size: 100% 100%;
        background-position: center center;
        background-repeat: no-repeat;
        -webkit-transition: all 1s;
        transition: all 1s;
      }

      #app {
        position: relative;
      }

      #result-btn {
        position: absolute;
        top: 0;
        right: 0;
        margin-top: 20px;
        text-align: right;
        margin-right: 30px;
        text-decoration: none;
        color: white;
      }

      #result {
        position: absolute;
        height: 60%;
        width: 100%;
        overflow-y: auto;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        text-align: center;
        padding: 10px;
        scrollbar-width: none; /* Firefox */
        -webkit-scrollbar-width: none; /* Webkit */
      }

      #result span {
        display: inline-block;
        background: #fff;
        font-size: 25px;
        line-height: 30px;
        color: #000;
        margin: 5px;
        padding: 10px;
        border-radius: 10px;
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.8);
      }

      #tools {
        position: absolute;
        bottom: 20px;
        right: 20px;
        text-align: center;
      }

      #tools .pure-button {
        display: inline-block;
        margin: 5px;
        padding: 10px;
        text-align: center;
      }

      .pure-button {
        display: inline-block;
        zoom: 1;
        line-height: normal;
        white-space: nowrap;
        vertical-align: middle;
        text-align: center;
        cursor: pointer;
        -webkit-user-drag: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
      }

      .pure-button {
        font-family: inherit;
        font-size: 100%;
        padding: 0.5em 1em;
        color: #444;
        color: rgba(0, 0, 0, 0.8);
        border: 0 rgba(0, 0, 0, 0);
        background-color: #e6e6e6;
        text-decoration: none;
        border-radius: 2px;
      }

      .pure-button:focus {
        outline: 0;
      }

      .pure-button-hover,
      .pure-button:hover,
      .pure-button:focus {
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#00000000', endColorstr='#1a000000', GradientType=0);
        background-image: -webkit-gradient(
          linear,
          0 0,
          0 100%,
          from(transparent),
          color-stop(40%, rgba(0, 0, 0, 0.05)),
          to(rgba(0, 0, 0, 0.1))
        );
        background-image: -webkit-linear-gradient(transparent, rgba(0, 0, 0, 0.05) 40%, rgba(0, 0, 0, 0.1));
        background-image: -moz-linear-gradient(top, rgba(0, 0, 0, 0.05) 0, rgba(0, 0, 0, 0.1));
        background-image: -o-linear-gradient(transparent, rgba(0, 0, 0, 0.05) 40%, rgba(0, 0, 0, 0.1));
        background-image: linear-gradient(transparent, rgba(0, 0, 0, 0.05) 40%, rgba(0, 0, 0, 0.1));
      }

      .button-success,
      .button-error,
      .button-warning,
      .button-secondary {
        color: white;
        border-radius: 4px;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
      }
      .button-success {
        background: rgb(28, 184, 65);
      }
      .button-error {
        background: rgb(202, 60, 60);
      }
      .button-warning {
        background: rgb(223, 117, 20);
      }
      .button-secondary {
        background: rgb(66, 184, 221);
      }

      .mask {
        -webkit-filter: blur(5px);
        filter: blur(5px);
      }

      [v-cloak] {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="app" class="wall" v-cloak>
      <!-- Ê†áÁ≠æ‰∫ë -->
      <canvas :id="canvasId" :class="{mask: showResult}" :width="width" :height="height">
        <ul>
          <li v-for="item in member" :key="item.phone">
            <a href="#" :style="{color: winners.includes(getKey(item)) ? 'yellow' : 'white'}"> {{item.name}} </a>
          </li>
        </ul>
      </canvas>
      <!-- Ëé∑Â•ñÂêçÂçï -->
      <div id="result-btn" class="result-btn">
        <a href="./result.html" target="_blank">Ëé∑Â•ñÂêçÂçï</a>
      </div>
      <!-- ÊäΩÂ•ñÁªìÊûú -->
      <div id="result" class="result" v-show="showResult">
        <span v-for="item in currentWinner" :key="item.phone"> {{item.name}}<br />{{item.phone}} </span>
      </div>
      <!-- Êìç‰ΩúÊ†è -->
      <div id="tools" class="tools">
        <button
          v-for="item in prize"
          :key="item.name"
          class="pure-button"
          :class="{ 'button-error': currentPrize?.name === item.name}"
          :disabled="running"
          @click="handleChoosePrize(item)"
        >
          {{item.name}}({{item.quota}})
        </button>
        <button
          class="pure-button"
          :class="{'button-secondary': !running, 'button-success': running}"
          @click="handleToggle"
        >
          {{running?"ÂÅú!":"ÂºÄÂßã"}}
        </button>
        <button class="pure-button button-warning" @click="handelReset">ÈáçÁΩÆ</button>
      </div>
    </div>
    <script type="text/javascript" src="js/vue.min.js"></script>
    <script type="text/javascript" src="js/tagcanvas.min.js"></script>
    <script type="text/javascript" src="js/confetti.browser.min.js"></script>
    <script type="text/javascript">
      const app = new Vue({
        el: "#app",
        data() {
          return {
            member: [],
            prize: [],
            currentPrize: null,
            showResult: false,
            currentWinner: [],
            winnerList: null,
            running: false,
            socket: null,
            socketName: "ws://127.0.0.1:3000",
            canvasId: "ball",
            speed: [0.04, -0.06], // Â∑¶Âè≥ ‰∏ä‰∏ã
            width: document.body.offsetWidth,
            height: document.body.offsetHeight,
            syncPush: true,
          };
        },
        computed: {
          winners() {
            const list = [];
            if (this.winnerList) {
              Object.keys(this.winnerList).forEach((prizeName) => {
                this.winnerList[prizeName].forEach((memberItem) => {
                  list.push(this.getKey(memberItem));
                });
              });
            }
            return list;
          },
        },
        watch: {
          currentPrize(newVal, oldVal) {
            this.send("currentPrize", newVal);
          },
          showResult(newVal, oldVal) {
            this.send("showResult", newVal);
            if (newVal) {
              requestAnimationFrame(this.fireworks);
            }
          },
          currentWinner(newVal, oldVal) {
            this.send("currentWinner", newVal);
          },
          winnerList(newVal, oldVal) {
            // console.log("üöÄ ~ winnerList:", newVal, oldVal);
            this.send("winnerList", newVal);
            // ‰øùÂ≠òÂêçÂçï(Ë∑®È°µÈù¢‰º†ËæìÁî®)
            localStorage.setItem("winnerList", JSON.stringify(newVal));
            // ÈáçËΩΩÊ†áÁ≠æ‰∫ë
            this.$nextTick(() => {
              TagCanvas.Reload(this.canvasId);
            });
          },
        },
        created() {
          this.syncPush
            ? this.createSocket()
            : this.loadScript("js/config.js", () => {
                const winnerListStr = localStorage.getItem("winnerList");
                this.init({
                  member: member.length > 0 ? member : this.member,
                  prize: prize.length > 0 ? prize : this.prize,
                  currentPrize: prize.length > 0 ? prize[0] : this.currentPrize,
                  showResult: this.showResult,
                  currentWinner: this.currentWinner,
                  winnerList: winnerListStr !== null ? JSON.parse(winnerListStr) : this.winnerList,
                  running: this.running,
                });
              });
        },
        mounted() {},
        methods: {
          createSocket() {
            // ÂàõÂª∫WebSocketÂÆû‰æãÔºåËøûÊé•Âà∞ÊåáÂÆöÁöÑÊúçÂä°Âô®Âú∞ÂùÄ
            const socket = new WebSocket(this.socketName);
            this.socket = socket;
            // ÂΩìËøûÊé•ÊàêÂäüÊâìÂºÄÊó∂Ëß¶ÂèëÁöÑ‰∫ã‰ª∂
            socket.onopen = (event) => {
              console.log("WebSocketËøûÊé•Â∑≤ÊâìÂºÄ");
              // ËøôÈáåÂèØ‰ª•ËøõË°å‰∏Ä‰∫õÂàùÂßãÂåñÊìç‰ΩúÔºåÊØîÂ¶ÇÂêëÊúçÂä°Âô®ÂèëÈÄÅËøûÊé•ÊàêÂäüÂêéÁöÑÊ†áËØÜÁ≠â
              this.send("tag", "master");
              // ÂøÉË∑≥
              setInterval(() => {
                this.send("ping");
              }, 50000);
            };
            // ÂΩìÊé•Êî∂Âà∞ÊúçÂä°Âô®ÂèëÈÄÅÁöÑÊ∂àÊÅØÊó∂Ëß¶ÂèëÁöÑ‰∫ã‰ª∂
            socket.onmessage = (event) => {
              console.log("WebSocketÊî∂Âà∞Ê∂àÊÅØ");
              // console.log(event.data);
              const message = JSON.parse(event.data);
              switch (message.emit) {
                case "init":
                  this.init(message.data);
                  break;
              }
            };
            // ÂΩìËøûÊé•Âá∫Áé∞ÈîôËØØÊó∂Ëß¶ÂèëÁöÑ‰∫ã‰ª∂
            socket.onerror = (error) => {
              console.log("WebSocketËøûÊé•Âá∫Èîô:", error);
              alert("WebSocketËøûÊé•Âá∫Èîô");
            };
            // ÂΩìËøûÊé•ÂÖ≥Èó≠Êó∂Ëß¶ÂèëÁöÑ‰∫ã‰ª∂
            socket.onclose = (event) => {
              console.log("WebSocketËøûÊé•Â∑≤ÂÖ≥Èó≠");
              if (confirm("ËøûÊé•Â∑≤Êñ≠ÂºÄÔºåÊòØÂê¶ÈáçËøûÔºü")) {
                location.reload();
              }
            };
          },
          loadScript(url, success, error) {
            const script = document.createElement("script");
            script.src = url;
            script.onload = () => {
              typeof success === "function" && success();
            };
            script.onerror = (event) => {
              console.error("Êó†Ê≥ïÂä†ËΩΩËÑöÊú¨Êñá‰ª∂Ôºö" + event.target.src);
              typeof success === "function" && error(event);
            };
            document.body.appendChild(script);
          },
          send(emit, data = null) {
            this.syncPush && this.socket.send(JSON.stringify({ emit, data }));
          },
          getKey(item) {
            return item.name + "-" + item.phone;
          },
          init({ member, prize, currentPrize, showResult, currentWinner, winnerList, running }) {
            this.member = member;
            this.prize = prize;
            this.currentPrize = currentPrize;
            this.showResult = showResult;
            this.currentWinner = currentWinner;
            this.winnerList = winnerList;
            // this.$nextTick‰∏≠ÁöÑÂõûË∞ÉÂáΩÊï∞Â∞±‰ºöÂú® DOM Êõ¥Êñ∞ÂêéÊâßË°å
            this.$nextTick(() => {
              TagCanvas.Start(this.canvasId, undefined, {
                textColour: null,
                initial: this.speed,
                dragControl: true,
                textHeight: 14,
              });
              // ÊÅ¢Â§çÁä∂ÊÄÅ
              if (running) {
                this.start(true);
              }
            });
          },
          start(resume) {
            if (resume !== true) {
              if (this.prize.length === 0) {
                alert("Â•ñÂìÅÂàóË°®‰∏∫Á©∫");
                return;
              }
              if (this.winners.length >= this.member.length) {
                alert("ÂèØ‰∏≠Â•ñ‰∫∫Êï∞‰∏çË∂≥");
                return;
              }
              if (this.winnerList && this.winnerList[this.currentPrize.name]) {
                if (!confirm("ÂΩìÂâçÂ•ñÈ°πÂ∑≤Êúâ‰∏≠Â•ñÂêçÂçïÔºåÊòØÂê¶ÈáçÊäΩ?")) {
                  return;
                }
              }
              this.send("start");
            }
            this.running = true;
            this.currentWinner = [];
            this.showResult = false;
            TagCanvas.SetSpeed(
              this.canvasId,
              this.speed.map((item) => item * 100)
            );
          },
          stop() {
            const currentWinner = this.lottery(this.currentPrize.quota);
            this.send("stop", currentWinner);
            TagCanvas.SetSpeed(this.canvasId, this.speed);
            this.running = false;
            this.currentWinner = currentWinner;
            this.showResult = true;
            if (this.winnerList === null) {
              this.winnerList = { [this.currentPrize.name]: currentWinner };
            } else {
              if (this.winnerList[this.currentPrize.name]) {
                this.$delete(this.winnerList, this.currentPrize.name);
              }
              this.$set(this.winnerList, this.currentPrize.name, currentWinner);
            }
          },
          lottery(count) {
            return this.member
              .filter((item) => {
                return !this.winners.includes(this.getKey(item));
              })
              .map((item) => {
                item.score = Math.random();
                return item;
              })
              .sort((a, b) => {
                return a.score - b.score;
              })
              .slice(0, count)
              .map((item) => {
                delete item.score;
                return item;
              });
          },
          fireworks() {
            function fire(particleRatio, opts) {
              confetti({
                ...{
                  origin: { y: 0.7 },
                },
                ...opts,
                particleCount: Math.floor(200 * particleRatio),
              });
            }
            fire(0.25, {
              spread: 26,
              startVelocity: 55,
            });
            fire(0.2, {
              spread: 60,
            });
            fire(0.35, {
              spread: 100,
              decay: 0.91,
              scalar: 0.8,
            });
            fire(0.1, {
              spread: 120,
              startVelocity: 25,
              decay: 0.92,
              scalar: 1.2,
            });
            fire(0.1, {
              spread: 120,
              startVelocity: 45,
            });
          },
          handleChoosePrize(prize) {
            this.currentPrize = prize;
            this.showResult = false;
          },
          handleToggle() {
            this.running ? this.stop() : this.start();
          },
          handelReset() {
            if (confirm("Á°ÆÂÆöË¶ÅÈáçÁΩÆ‰πàÔºüÊâÄÊúâ‰πãÂâçÁöÑÊäΩÂ•ñÂéÜÂè≤Â∞ÜË¢´Ê∏ÖÈô§ÔºÅ")) {
              this.send("reset");
              localStorage.clear();
              location.reload();
            }
          },
        },
      });
    </script>
  </body>
</html>
